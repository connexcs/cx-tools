# CX Tools - Sync Commands

Sync ScriptForge scripts, SQL queries, and templates between ConnexCS and your local filesystem.

**Performance:** All network requests are executed in parallel for maximum speed.

---

## File Structure

When using sync commands, the following directory structure is used:

| Path | Description |
|------|-------------|
| `./src/*.js` | ScriptForge JavaScript files |
| `./query/*.sql` | SQL query files |
| `./template/*.html` | HTML template files |
| `cx.env` | Synced environment variables metadata |
| `cx.toml` | Sync configuration and script metadata |

---

## Pull Scripts

### Command: `cx pull`

Download all ScriptForge scripts and SQL queries to your local folders:

```bash
cx pull          # Pull scripts (filtered by configured APP_ID)
cx pull -s       # Silent mode
```

### Options

| Option | Alias | Description |
|--------|-------|-------------|
| `-s` | `--silent` | Suppress decorative output |
| `-r` | `--raw` | Alias for `--silent` |

### Behavior

1. Fetches all ScriptForge scripts and SQL queries from your account
2. Fetches all file contents in parallel
3. Filters by configured APP_ID (if set)
4. Detects local files that will be overwritten
5. Shows diffs for files with local changes
6. Asks for confirmation
7. Saves scripts to `./src/<name>.js` and queries to `./query/<name>.sql`

### Diff Viewing

When local changes exist, you'll be prompted:

```
? Files with local changes detected. What would you like to do?
  ❯ View diffs before proceeding
    Continue without viewing diffs
    Cancel pull operation
```

Diff colors:
- **Green (+)**: Content from remote (will be added)
- **Red (-)**: Your local changes (will be removed)

---

## Push Changes

### Command: `cx push`

Upload local changes back to ScriptForge:

```bash
cx push          # Push local changes
cx push -s       # Silent mode
```

### Options

| Option | Alias | Description |
|--------|-------|-------------|
| `-s` | `--silent` | Suppress decorative output |
| `-r` | `--raw` | Alias for `--silent` |

### Behavior

1. Reads all `.js` files from `./src/` and `.sql` files from `./query/`
2. Fetches remote scripts/queries in parallel for comparison
3. Detects changes (modified or new files)
4. Shows diffs for files that will be updated
5. Asks for confirmation
6. Updates and creates all changes in parallel
7. Displays results as they complete

### File Naming

File names must match script/query names:
- `./src/my-script.js` → Script name: `my-script`
- `./query/daily-report.sql` → Query name: `daily-report`

### Creating New Scripts

New scripts require an APP_ID to be configured:

```bash
cx configure:app   # Select app first
cx push            # Then push new files
```

### Diff Viewing

When pushing updates, you'll be prompted:

```
? Would you like to view diffs before pushing?
  ❯ View diffs for files to be updated
    Continue without viewing diffs
    Cancel push operation
```

Diff colors:
- **Red (-)**: Current remote version (will be removed)
- **Green (+)**: Your local changes (will be added)

---

## Clear Local Files

### Command: `cx clear`

Clear all files from local folders:

```bash
cx clear         # Clear with confirmation
cx clear -s      # Silent mode
```

### Options

| Option | Alias | Description |
|--------|-------|-------------|
| `-s` | `--silent` | Suppress decorative output |
| `-r` | `--raw` | Alias for `--silent` |

### Behavior

1. Lists all files in `./src/`, `./query/`, `./template/`
2. Lists `cx.env` and `cx.toml` files
3. Asks for confirmation (defaults to No for safety)
4. Deletes all listed files

---

## Typical Workflow

```bash
# 1. Configure credentials and app
cx configure
cx configure:app

# 2. Pull existing scripts from ConnexCS
cx pull

# 3. Edit scripts locally
# ... make your changes in ./src/ ...

# 4. Push changes back to ConnexCS
cx push

# 5. Test your script
cx run my-script

# 6. Optional: Clear local files when done
cx clear
```

---

## cx.toml Configuration

The `cx.toml` file stores metadata about synced scripts:

```toml
# Auto-generated by cx pull
# Do not edit manually

[[scripts]]
id = 12345
name = "my-script"
app_id = 67890

[[scripts]]
id = 12346
name = "another-script"
app_id = 67890

[[queries]]
id = 789
name = "daily-report"
```

This file is used by `cx push` to:
- Map local files to remote script IDs
- Determine if a file is new or an update
- Track which app a script belongs to

---

## Error Handling

| Error | Solution |
|-------|----------|
| `APP_ID required for new scripts` | Run `cx configure:app` first |
| `File not found` | Ensure file exists in correct directory |
| `Script name mismatch` | File name must match script name |
| `Permission denied` | Check file system permissions |
